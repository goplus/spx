<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
	<title>XGo Builder</title>
	<script src="ffmpeg/ffmpeg/package/dist/umd/ffmpeg.js"></script>
	<script src="ffmpeg/util/package/dist/umd/index.js"></script>
	<script src="videoRecorder.js"></script>
	<style>
		*:focus {
			outline: none;
			background-color: black;
		}

		#canvas,
		#gameCanvas {
			display: block;
			margin: 0;
			color: white;
		}
		
		body {
			background-color: #333;
			margin: 0;
			color: white;
		}
		/* 添加动画容器和动画盒子的样式 */
		.control-group {
			margin-bottom: 20px;
		}
		
		.animation-container {
			width: 300px;
			height: 30px;
			background-color: #f0f0f0;
			position: relative;
			overflow: hidden;
			border-radius: 15px;
			margin-top: 10px;
		}
		
		.animation-box {
			width: 50px;
			height: 20px;
			background-color: #4CAF50;
			position: absolute;
			top: 5px;
			left: 0;
			border-radius: 10px;
			animation: slide 2s infinite alternate ease-in-out;
		}
		
		@keyframes slide {
			0% {
				left: 0;
			}
			100% {
				left: calc(100% - 50px);
			}
		}

		/* 录制相关样式 */
		.recording-controls {
			display: inline-flex;
			align-items: center;
			gap: 10px;
			margin: 0;
			padding: 0;
		}

		.recording-checkbox {
			display: flex;
			align-items: center;
			gap: 5px;
		}

		.recording-checkbox input[type="checkbox"] {
			width: 16px;
			height: 16px;
			cursor: pointer;
		}

		.recording-checkbox label {
			font-size: 14px;
			cursor: pointer;
			white-space: nowrap;
		}

		.status {
			font-size: 14px;
			padding: 2px 8px;
			border-radius: 3px;
			white-space: nowrap;
		}
		
		.status.recording {
			background: #ffebee;
			color: #c62828;
		}
		
		.status.ready {
			background: #e8f5e8;
			color: #2e7d32;
		}
		
		.status.success {
			background: #e3f2fd;
			color: #1976d2;
		}

		.progress-section {
			background: #555;
			border: 1px solid #666;
			border-radius: 8px;
			padding: 20px;
			margin: 20px 0;
			display: none;
		}
		
		.progress-bar {
			width: 100%;
			height: 25px;
			background: #666;
			border-radius: 12px;
			overflow: hidden;
			margin: 15px 0;
			box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
		}
		
		.progress-fill {
			height: 100%;
			background: linear-gradient(90deg, #4CAF50, #45a049);
			width: 0%;
			transition: width 0.3s ease;
			border-radius: 12px;
			position: relative;
		}
		
		.progress-fill::after {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1), rgba(255,255,255,0.2));
			animation: shimmer 2s infinite;
		}
		
		@keyframes shimmer {
			0% { transform: translateX(-100%); }
			100% { transform: translateX(100%); }
		}

		#transcode-message {
			font-size: 16px;
			font-weight: bold;
			color: #fff;
			margin: 0 0 10px 0;
		}
		
		#transcode-time-info {
			font-size: 14px;
			color: #ccc;
			margin: 10px 0 0 0;
		}
	</style>
</head>

<body>
	<button id="startGameBtn">Start</button>
	<button id="stopGameBtn">Stop</button>
	<!-- 录制控制区域 -->
	<div class="recording-controls">
		<div class="recording-checkbox">
			<input type="checkbox" id="recordingCheckbox">
			<label for="recordingCheckbox">录制</label>
		</div>
		<span id="recordingStatus" class="status ready" style="display: none;">就绪</span>
	</div>
	<progress id="progress-bar" value="0" max="1" style="display: none;"></progress>
	
	<!-- 转码进度区域 -->
	<div id="transcode-section" class="progress-section">
		<p id="transcode-message">准备转码...</p>
		<div class="progress-bar">
			<div id="transcode-progress-fill" class="progress-fill"></div>
		</div>
		<p id="transcode-time-info">转码时间: 0s</p>
	</div>

	<div id="tabs">
		<div id="tab-loader">
		</div>
		<div id="tab-game" style="display: none;">
		</div>
	</div>
	<div class="control-group">
		<h2>Test Animation</h2>
		<div class="animation-container">
			<div class="animation-box"></div>
		</div>
	</div>
	<iframe id="runnerFrame" src="runner.html" width="1600" height="700"></iframe>

	<script>
		// 全局变量
		let videoRecorder = null;
		let isRecording = false;
		let gameLoaded = false;

		// 状态更新函数
		function updateStatus(message, type = 'ready') {
			const statusDiv = document.getElementById('recordingStatus');
			if (statusDiv) {
				statusDiv.textContent = message;
				statusDiv.className = `status ${type}`;
				statusDiv.style.display = 'block';
				console.log(`录制状态: ${message}`);
			}
		}

		// 日志函数
		function log(message) {
			console.log(`[录制器] ${message}`);
		}

		// 初始化录制器
		async function initVideoRecorder() {
			if (!runnerWindow.spxCanvas) {
				log('Canvas尚未准备好，无法初始化录制器');
				return false;
			}

			try {
				log('开始初始化录制器...');
				videoRecorder = new VideoRecorder(runnerWindow.spxCanvas, log);
				const success = await videoRecorder.init();
				
				if (success) {
					updateStatus('就绪', 'ready');
					log('录制器初始化成功');
					return true;
				} else {
					updateStatus('初始化失败', 'ready');
					log('录制器初始化失败');
					return false;
				}
			} catch (error) {
				log('初始化录制器时出错: ' + error.message);
				updateStatus('初始化出错', 'ready');
				return false;
			}
		}

		window.addEventListener('load', function() {
			animateBox();
		});

		function animateBox() {
			const box = document.querySelector('.animation-box');
			if (!box) return;
			const style = window.getComputedStyle(box);
			if (style.animationName !== 'none') return;
			let position = 0;
			let direction = 1;
			setInterval(() => {
				if (position >= 250) direction = -1;
				if (position <= 0) direction = 1;
				
				position += direction * 2;
				box.style.left = position + 'px';
			}, 20);
		}

		let runnerWindow = {}
		document.getElementById('startGameBtn').addEventListener('click', startGame);
		document.getElementById('stopGameBtn').addEventListener('click', stopGame);
		runnerWindow = document.getElementById('runnerFrame').contentWindow;

		function onProgress(value) {
			document.getElementById('progress-bar').value = value;
			if (value >= 1) {
				document.getElementById('tab-game').style.display = 'block';
				document.getElementById('tab-loader').style.display = 'none';
				
				// 游戏加载完成，初始化录制器
				gameLoaded = true;
				setTimeout(async () => {
					await initVideoRecorder();
				}, 500); // 等待500ms确保canvas完全就绪
			}
			document.getElementById('progress-bar').style.display = value >= 1 ? 'none' : 'block';
		}

		async function startGame() {
			await startProject('/game.zip');
			
			// 检查是否需要录制
			const recordingCheckbox = document.getElementById('recordingCheckbox');
			const shouldRecord = recordingCheckbox.checked;
			
			if (shouldRecord) {
				if (!videoRecorder) {
					log('录制器尚未初始化，等待初始化完成...');
					updateStatus('等待初始化...', 'recording');
					
					// 等待录制器初始化完成
					let attempts = 0;
					const maxAttempts = 20; // 最多等待10秒
					
					while (!videoRecorder && attempts < maxAttempts) {
						await new Promise(resolve => setTimeout(resolve, 500));
						attempts++;
					}
					
					if (!videoRecorder) {
						log('录制器初始化超时，无法开始录制');
						updateStatus('初始化超时', 'ready');
						return;
					}
				}
				
				// 开始录制
				const success = videoRecorder.start();
				if (success) {
					isRecording = true;
					log('游戏开始，自动开始录制视频');
					updateStatus('录制中...', 'recording');
				} else {
					log('自动录制失败');
					updateStatus('录制失败', 'ready');
				}
			}
		}

		async function stopGame() {
			// 如果正在录制，停止录制并自动下载
			if (isRecording && videoRecorder) {
				const success = videoRecorder.stop();
				if (success) {
					isRecording = false;
					log('游戏结束，自动停止录制视频，开始转码处理...');
					updateStatus('处理中...', 'success');
				} else {
					log('自动停止录制失败');
					updateStatus('停止失败', 'ready');
				}
			}

			runnerWindow.stopGame()
		}

		async function startProject(zipUrl) {
			gameLoaded = false;
			videoRecorder = null; // 重置录制器
			
			runnerWindow.addEventListener('onProgress', (event) => {
				onProgress(event.detail.progress)
			})
			runnerWindow.onGameError(function (callback) {
				console.error("onGameError", callback)
			})
			runnerWindow.spxIsForceDebugLog = true
			let buffer = await (await (fetch(zipUrl))).arrayBuffer();
			await runnerWindow.startGame(buffer, null, function () {
				runnerWindow.setAIInteractionAPIEndpoint("http://127.0.0.1:8000")
			});
		}

		// 监听checkbox状态变化
		document.addEventListener('DOMContentLoaded', () => {
			const recordingCheckbox = document.getElementById('recordingCheckbox');
			recordingCheckbox.addEventListener('change', function() {
				const statusDiv = document.getElementById('recordingStatus');
				if (this.checked) {
					statusDiv.style.display = 'inline';
					if (videoRecorder) {
						updateStatus('已启用', 'ready');
					} else if (gameLoaded) {
						updateStatus('等待初始化...', 'ready');
					} else {
						updateStatus('等待加载...', 'ready');
					}
				} else {
					statusDiv.style.display = 'none';
				}
			});
		});
	</script>
</body>

</html>
